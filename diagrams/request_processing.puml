@startuml

title RTB request processing

participant Publisher
participant RequestActor
participant Factory
participant Parser
participant Validator
participant Writer

Publisher -> RequestActor: HTTP request
activate RequestActor

RequestActor -> Parser: HTTP request
activate Parser

alt HTTP request parsed to AdRequest
    RequestActor <-- Parser: AdRequest
    deactivate Parser
    RequestActor -> Factory: AdRequest
    activate Factory

    alt BidRequest created from AdRequest
        RequestActor <-- Factory: BidRequest
        deactivate Factory

        ref over RequestActor: getting AdResponse

    else BidRequest not created from AdRequest
        RequestActor <-- Factory: fail
        deactivate Factory

        RequestActor -> Factory: Error
        activate Factory
        RequestActor <-- Factory: AdResponse
        deactivate Factory

        activate Parser
    end

else HTTP request not parsed to AdRequest
    RequestActor <-- Parser: fail
    deactivate Parser

    RequestActor -> Factory: Error
    activate Factory
    RequestActor <-- Factory: AdResponse
    deactivate Factory
end

RequestActor -> Writer: AdResponse
activate Writer
RequestActor <-- Writer: HTTP response
deactivate Writer
RequestActor --> Publisher: HTTP response
deactivate RequestActor

@enduml
