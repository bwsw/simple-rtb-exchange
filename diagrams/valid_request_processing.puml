@startuml

title Valid RTB request processing

participant Publisher
participant Exchange
participant Factory
participant Parser
participant Validator
participant Writer
participant BidActor
participant WinBidActor
participant Bidder

Publisher -> Exchange: HTTP request
activate Exchange

Exchange -> Parser: HTTP request
activate Parser

alt HTTP request parsed to AdRequest
    Exchange <-- Parser: AdRequest
    deactivate Parser
    Exchange -> Factory: AdRequest
    activate Factory

    alt BidRequest created from AdRequest
        Exchange <-- Factory: BidRequest
        deactivate Factory

        Exchange ->> BidActor: BidRequest
        activate BidActor

        BidActor -> Writer: BidRequest
        activate Writer
        Writer --> BidActor: HTTP request
        deactivate Writer

        BidActor -> Bidder: HTTP request
        activate Bidder
        opt Got HTTP response
            BidActor <-- Bidder: HTTP response
            deactivate Bidder

            BidActor -> Parser: HTTP response
            activate Parser

            BidActor <-- Parser: BidResponse/Parsing fail
            deactivate Parser
            opt HTTP response parsed to BidResponse
                BidActor -> Validator: BidResponse
                activate Validator
                BidActor <-- Validator: true/false
                deactivate Validator
                opt BidResponse is valid
                    Exchange <<- BidActor: BidResponse
                end
            end
        end

        deactivate BidActor
            
        Exchange -> Exchange: Auction

        alt Win Bidder is found
            Exchange -> WinBidActor: Win Notice
            activate WinBidActor
            WinBidActor -> Bidder: HTTP request
            activate Bidder
            opt Got HTTP response
                WinBidActor <-- Bidder: HTTP response
                deactivate Bidder
                Exchange <-- WinBidActor: Ad url/markup (if it is not in BidResponse)
                deactivate WinBidActor
                
                Exchange -> Factory: BidResponse
                activate Factory
                Exchange <-- Factory: AdResponse
                deactivate Factory
            end

        else Win Bidder is not found
            Exchange -> Factory: Error
            activate Factory
            Exchange <-- Factory: AdResponse
        end

    else BidRequest not created from AdRequest
        Exchange <-- Factory: Factoring fail
        deactivate Factory

        Exchange -> Factory: Error
        activate Factory
        Exchange <-- Factory: AdResponse
        deactivate Factory

        activate Parser
    end

else HTTP request not parsed to AdRequest
    Exchange <-- Parser: Parsing fail
    deactivate Parser

    Exchange -> Factory: Error
    activate Factory
    Exchange <-- Factory: AdResponse
    deactivate Factory
end

Exchange -> Writer: AdResponse
activate Writer
Exchange <-- Writer: HTTP response
deactivate Writer
Exchange --> Publisher: HTTP response
deactivate Exchange

@enduml
