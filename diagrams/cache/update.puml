@startuml

title: Cache updating

boundary CacheUpdater
control DAO
control CacheHelper
database DB

== System initialization ==

DAO -> CacheUpdater: attach(this)

== System working ==

[-> CacheUpdater: update
activate CacheUpdater

loop for all attached DAO
    CacheUpdater -> DAO: notify(CacheUpdating)
    activate DAO
    DAO -> DB: select
    DAO <-- DB: all entities with tsversion > last tsversion
    DAO -> CacheHelper: updateCache(entities)
    activate CacheHelper

    CacheHelper -> CacheHelper: remove deleted
    activate CacheHelper
    deactivate CacheHelper

    CacheHelper -> CacheHelper: add created
    activate CacheHelper
    deactivate CacheHelper

    CacheHelper -> CacheHelper:  update changed
    activate CacheHelper
    deactivate CacheHelper
    deactivate CacheHelper

    DAO -> DAO: update tsversion
    activate DAO
    deactivate DAO
    deactivate DAO

end

deactivate CacheUpdater


@enduml
