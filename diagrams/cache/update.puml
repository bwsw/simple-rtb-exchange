@startuml

title: Cache updating

boundary CacheUpdater
control DAO
control CacheHelper
database DB

== System initialization ==

DAO -> CacheUpdater: attach(this)
DAO <-- CacheUpdater

== System working ==

[--> CacheUpdater: update

activate CacheUpdater
    CacheUpdater -> DAO: notify(UpdateCache)
    activate DAO
        DAO -> DB: select
        DAO <-- DB: all entities with tsversion > lasttsversion
        DAO -> CacheHelper: updateCache(entities)
        activate CacheHelper
            loop for each entity
                CacheHelper -> CacheHelper: check for deleted and delete
                CacheHelper -> CacheHelper: check for updated and update
            end
            CacheHelper -> CacheHelper: update tsversion
            CacheHelper --> DAO
        deactivate CacheHelper
        DAO --> CacheUpdater
    deactivate DAO
deactivate CacheUpdater

@enduml
